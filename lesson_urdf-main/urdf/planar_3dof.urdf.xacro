<?xml version="1.0"?>
<robot name="legrobot" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:arg name="pkg_share" default=""/>
  <xacro:arg name="controllers_yaml" default=""/>
  <xacro:arg name="mesh_scale" default="1 1 1"/>

  <!-- ========= Args ========= -->
  <xacro:arg name="mesh_package" default="lesson_urdf"/>
  <xacro:arg name="fix_to_world" default="false"/>

  <!-- =========================
       LINKS + JOINTS
       ========================= -->

  <link name="base_link">
    <inertial>
      <origin xyz="-0.0025025 -0.17588 0.25152" rpy="0 0 0"/>
      <mass value="0.31319"/>
      <inertia
        ixx="0.0011307"  ixy="-1.0144E-05" ixz="5.0665E-05"
        iyy="0.0011316"  iyz="6.2853E-05"  izz="0.00011229"/>
    </inertial>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/base_link.STL" scale="$(arg mesh_scale)"/>
      </geometry>
      <material name="base_color">
        <color rgba="0.89804 0.92157 0.92941 1"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/base_link.STL" scale="$(arg mesh_scale)"/>
      </geometry>
    </collision>
  </link>

  <link name="link_p">
    <inertial>
      <origin xyz="-0.000150427229849236 -0.00297528930070973 0.0208919297661822" rpy="0 0 0"/>
      <mass value="0.138380104137137"/>
      <inertia
        ixx="5.05247266315499E-05" ixy="6.91643752688145E-07" ixz="-5.29990486490267E-08"
        iyy="6.42572200451749E-05" iyz="-1.03863238761051E-06" izz="4.27301161244844E-05"/>
    </inertial>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/link_p.STL" scale="$(arg mesh_scale)"/>
      </geometry>
      <material name="yellow_p">
        <color rgba="1 1 0 1"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/link_p.STL" scale="$(arg mesh_scale)"/>
      </geometry>
    </collision>
  </link>

  <joint name="joint_p" type="continuous">
    <origin xyz="-0.0024512 -0.097818 0.25643" rpy="1.5091 0 -3.1416"/>
    <parent link="base_link"/>
    <child link="link_p"/>
    <axis xyz="0 0 1"/>
  </joint>

  <link name="link_c">
    <inertial>
      <origin xyz="0.315330280840531 -2.34606143384025E-05 -0.010047091614373" rpy="0 0 0"/>
      <mass value="0.3089298949799"/>
      <inertia
        ixx="7.20297996548906E-05" ixy="-1.74839874712284E-09" ixz="-4.98731333977898E-06"
        iyy="0.000717249875302029" iyz="-1.3946552312525E-08" izz="0.00073083436101478"/>
    </inertial>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/link_c.STL" scale="$(arg mesh_scale)"/>
      </geometry>
      <material name="yellow_c">
        <color rgba="1 1 0 1"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/link_c.STL" scale="$(arg mesh_scale)"/>
      </geometry>
    </collision>
  </link>

  <joint name="joint_c" type="continuous">
    <origin xyz="0.0021041 0.042122 0.02325" rpy="1.5708 0 3.0917"/>
    <parent link="link_p"/>
    <child link="link_c"/>
    <axis xyz="0 0 -1"/>
  </joint>

  <link name="link_r">
    <inertial>
      <origin xyz="0.212306297554012 1.94867171676716E-06 -0.011447592682255" rpy="0 0 0"/>
      <mass value="0.184300341408798"/>
      <inertia
        ixx="3.3203754311843E-05" ixy="-2.50204353742291E-09" ixz="-1.00150733282631E-10"
        iyy="0.000663634897908807" iyz="-2.39351302771645E-10" izz="0.000665757228078733"/>
    </inertial>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/link_r.STL" scale="$(arg mesh_scale)"/>
      </geometry>
      <material name="yellow_r">
        <color rgba="1 1 0 1"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file://$(arg pkg_share)/meshes/link_r.STL" scale="$(arg mesh_scale)"/>
      </geometry>
    </collision>
  </link>

  <joint name="joint_r" type="continuous">
    <origin xyz="0.468 0 0.037775" rpy="0 0 0"/>
    <parent link="link_c"/>
    <child link="link_r"/>
    <axis xyz="0 0 -1"/>
  </joint>

  <!-- ===== FOOT / TIP EXACTO EN PUNTA DEL STL ===== -->
  <link name="foot_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <sphere radius="0.01"/>
      </geometry>
      <material name="red">
        <color rgba="1 0 0 1"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <sphere radius="0.01"/>
      </geometry>
    </collision>
  </link>

  <joint name="joint_foot" type="fixed">
    <origin xyz="0.441000 0.0 -0.0117" rpy="0 0 0"/>
    <parent link="link_r"/>
    <child link="foot_link"/>
  </joint>

  <!-- =========================
       Gazebo Classic materials
       ========================= -->
  <gazebo reference="base_link"><material>Gazebo/Grey</material></gazebo>
  <gazebo reference="link_p"><material>Gazebo/Yellow</material></gazebo>
  <gazebo reference="link_c"><material>Gazebo/Yellow</material></gazebo>
  <gazebo reference="link_r"><material>Gazebo/Yellow</material></gazebo>
  <gazebo reference="foot_link"><material>Gazebo/Red</material></gazebo>

  <!-- Optional: fixed to world (debug) -->
  <!-- Optional: fixed to world (debug / keep stable in Gazebo) -->
  <xacro:if value="$(arg fix_to_world)">
    <link name="world"/>
    <joint name="world_joint" type="fixed">
      <parent link="world"/>
      <child link="base_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </joint>
  </xacro:if>

<!-- =========================
       ros2_control + Gazebo plugin
       ========================= -->

  <ros2_control name="GazeboSystem" type="system">
    <hardware>
      <plugin>gazebo_ros2_control/GazeboSystem</plugin>
    </hardware>

    <joint name="joint_p">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="joint_c">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>

    <joint name="joint_r">
      <command_interface name="position"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
    </joint>
  </ros2_control>

  <gazebo>
    <plugin name="gazebo_ros2_control" filename="libgazebo_ros2_control.so">
      <robotNamespace>/</robotNamespace>
      <parameters>$(arg controllers_yaml)</parameters>
    </plugin>
  </gazebo>

</robot>